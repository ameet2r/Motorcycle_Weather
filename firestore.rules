rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Security rules for Motorcycle Weather API
    // ALL Firestore access goes through the backend service account ONLY
    // This prevents clients from bypassing backend authentication/authorization

    // IMPORTANT: Replace this with your actual service account email
    // Find it by running: cat /path/to/service-account-key.json | grep "client_email"
    // Or in Firebase Console → Project Settings → Service Accounts
    function isBackendServiceAccount() {
      return request.auth != null &&
        request.auth.token.email == 'YOUR-SERVICE-ACCOUNT-EMAIL@YOUR-PROJECT.iam.gserviceaccount.com';
    }

    // Default: Deny all direct client access (secure by default)
    // This ensures all access goes through your authenticated backend API
    match /{document=**} {
      allow read, write: if false;
    }

    // Weather caching collections - backend service account only
    match /coordinates/{coordinateId} {
      allow read, write: if isBackendServiceAccount();
    }

    match /gridpoints/{gridpointId} {
      allow read, write: if isBackendServiceAccount();
    }

    match /forecasts/{forecastId} {
      allow read, write: if isBackendServiceAccount();
    }

    match /alerts/{alertId} {
      allow read, write: if isBackendServiceAccount();
    }

    // Users collection - backend service account only
    // Authorization logic is in backend code (server/main.py)
    match /users/{userId} {
      allow read, write: if isBackendServiceAccount();
    }

    // Searches collection - backend service account only
    // User ownership and tier checks are handled in backend code:
    // - Ownership verification: server/main.py:776-784, 842-850, 954-961
    // - Tier restrictions: server/main.py:582, 651, 745, etc. (require_plus_tier dependency)
    match /searches/{searchId} {
      allow read, write: if isBackendServiceAccount();
    }

    // Health check collection - backend service account only
    match /health_check/{document} {
      allow read: if isBackendServiceAccount();
    }
  }
}
